<?php

namespace CVEBot\Plugin;

require_once __DIR__ . '/../Config.php';

use Phergie\Irc\Event\EventInterface as Event;
use Phergie\Irc\Bot\React\EventQueueInterface as Queue;
use Phergie\Irc\Bot\React\PluginInterface;

class RehashPlugin implements PluginInterface {
    public function getSubscribedEvents() {
        return array(
            'irc.received.privmsg' => 'onPrivmsg'
        );
    }

    public function onPrivmsg(Event $event, Queue $queue) {
        $source = $event->getSource();
        $params = $event->getParams();

        $isRehashCommand = preg_match('/^!rehash$/', $params['text']) === 1;
        $isAdmin = $source === 'case_';

        if ($isRehashCommand && $isAdmin) {
            $didSucceed = \CVEBot\Config::getInstance()->reload();
            $message = $didSucceed
                ? 'Configuration rehashed'
                : 'Error reading configuration';

            $queue->ircPrivmsg($source, $message);
        }
    }
}
