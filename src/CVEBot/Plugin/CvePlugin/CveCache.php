<?php

namespace CveBot\Plugin\CvePlugin;

require_once __DIR__ . '/Cve.php';

class CveCache {
    protected $db = array();

    public function addItems(array $items) {
        array_walk($items, array($this, 'addItem'));
    }

    public function addItem(Cve $item) {
        if (!$this->inCache($item)) {
            $this->db[$item->getName()] = $item;
        }
    }

    public function prune() {
        // Flush CVEs from memory older than 8 days (NIST maximum for RSS feed)
        $this->db = array_filter($this->db, function($item) {
            return time() - $item->getTimestamp() < 60 * 60 * 24 * 8;
        });
    }

    public function inCache(Cve $item) {
        $name = $item->getName();

        return array_key_exists($name, $this->db)
            && $item->getTimestamp() <= $this->db[$name]->getTimestamp();
    }
}
