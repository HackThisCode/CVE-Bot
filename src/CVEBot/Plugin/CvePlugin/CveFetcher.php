<?php

namespace CveBot\Plugin\CvePlugin;

require_once __DIR__ . '/Cve.php';

use FastFeed\Factory;

date_default_timezone_set('UTC');

class CveFetcher {
    protected $url;

    public function __construct($url) {
        $this->url = $url;
    }

    public function fetch() {
        $fastFeed = Factory::create();
        $fastFeed->addFeed('default', $this->url);

        $rows = $fastFeed->fetch('default');

        return array_map(array($this, 'buildCVE'), $rows);
    }

    protected function buildCVE($row) {
        $url = $row->getSource();
        $timestamp = gmdate('r');//$row['dc']['date'];

        preg_match('#(CVE\-\d+\-\d+)(?:\s*\(([^\)]+)\))?#', trim($row->getName()), $matches);

        $name = $matches[1];
        $tags = count($matches) == 3
            ? preg_split('/\s*,\s*/', $matches[2])
            : array();
        $desc = str_replace("\n", '', $row->getContent());

        return new Cve(
            $name,
            strtotime($timestamp),
            $url,
            $tags,
            $desc
        );
    }
}
