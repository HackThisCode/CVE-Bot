<?php

namespace CveBot\Plugin\CvePlugin;

class Cve {
    private $name;
    private $timestamp;
    private $url;
    private $tags;
    private $desc;

    public function __construct($name, $timestamp, $url, $tags, $desc) {
        $this->name = $name;
        $this->timestamp = $timestamp;
        $this->url = $url;
        $this->tags = $tags;
        $this->desc = $desc;
    }

    public function getName() {
        return $this->name;
    }

    public function getTimestamp() {
        return $this->timestamp;
    }

    public function getTags() {
        return $this->tags;
    }

    public function getDescription() {
        return $this->desc;
    }

    public function format() {
        $timestamp = date('M j Y H:i:s', $this->timestamp);
        $desc = strlen($this->desc) > 250
            ? substr($this->desc, 0, 250) . ' ...'
            : $this->desc;

        return "[{$this->name}] ($timestamp) {$this->url} -- $desc";
    }

    static public function fromRss($row) {
        $url = $row->getSource();
        $timestamp = gmdate('r');//$row['dc']['date'];

        preg_match('#(CVE\-\d+\-\d+)(?:\s*\(([^\)]+)\))?#', trim($row->getName()), $matches;

        $name = $matches[1];
        $tags = $matches[2]
            ? preg_split('/\s*,\s*/', $matches[2])
            : array();
        $desc = str_replace("\n", '', $row->getContent());

        return new Cve(
            $name,
            strtotime($timestamp),
            $url,
            $tags,
            $desc
        );
    }
}
